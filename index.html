<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Furqan Tuitions | Rayyan</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
    }

    header {
      padding: 16px;
      font-size: 22px;
      font-weight: 600;
      text-align: center;
    }

    .container {
      padding: 16px;
      max-width: 480px;
      margin: auto;
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      margin-bottom: 16px;
      font-size: 16px;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .day {
      padding: 14px 0;
      border-radius: 12px;
      background: rgba(255,255,255,0.12);
      text-align: center;
      font-size: 14px;
      cursor: pointer;
    }

    .taken { background: #1db954; }
    .missed { background: #d9534f; }

    .overall {
      margin-top: 28px;
      display: grid;
      gap: 16px;
    }

    .card {
      background: rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 16px;
    }

    ul { padding-left: 18px; }

    #classModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: #111;
      width: 90%;
      max-width: 320px;
      padding: 20px;
      border-radius: 16px;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
    }

    button {
      background: #1db954;
      color: #fff;
      font-weight: 600;
    }
  </style>
</head>

<body>

<header>Furqan Tuitions – Rayyan</header>

<div class="container">
  <select id="monthSelect"></select>
  <div class="calendar" id="calendar"></div>

  <div class="overall">
    <div class="card">
      <h3>Maths – Topics</h3>
      <ul id="mathsTopics"></ul>
    </div>
    <div class="card">
      <h3>Physics – Topics</h3>
      <ul id="physicsTopics"></ul>
    </div>
  </div>
</div>

<div id="classModal">
  <div class="modal">
    <h3>Mark Class</h3>
    <select id="subjectSelect">
      <option value="maths">Maths</option>
      <option value="physics">Physics</option>
    </select>
    <input id="topicInput" placeholder="Topic studied">
    <button id="saveBtn">Save</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  document.addEventListener("DOMContentLoaded", () => {

    const firebaseConfig = {
      apiKey: "AIzaSyD5iFJYPEU3B0eohoFl_pGD75ZzX-onQsE",
      authDomain: "furqantuitions.firebaseapp.com",
      databaseURL: "https://furqantuitions-default-rtdb.firebaseio.com",
      projectId: "furqantuitions",
      storageBucket: "furqantuitions.appspot.com",
      messagingSenderId: "816451833675",
      appId: "1:816451833675:web:eda7c6a26f8e202effa2ce"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const isTeacher = new URLSearchParams(location.search).get("teacher") === "furqan@admin";

    const calendar = document.getElementById("calendar");
    const monthSelect = document.getElementById("monthSelect");
    const modal = document.getElementById("classModal");
    const saveBtn = document.getElementById("saveBtn");
    const topicInput = document.getElementById("topicInput");
    const subjectSelect = document.getElementById("subjectSelect");

    let selectedDate = "";

    function renderCalendar(y, m) {
      calendar.innerHTML = "";
      const days = new Date(y, m + 1, 0).getDate();

      for (let d = 1; d <= days; d++) {
        const box = document.createElement("div");
        box.className = "day";
        box.textContent = d;

        const key = `${y}-${m+1}-${d}`;
        const dayRef = ref(db, `rayyan/classes/${key}`);

        onValue(dayRef, s => {
          if (s.exists()) box.classList.add(s.val().status);
        });

        box.onclick = () => {
          selectedDate = key;
          if (isTeacher) modal.style.display = "flex";
        };

        calendar.appendChild(box);
      }
    }

    function loadMonths() {
      const now = new Date();
      for (let i = 0; i < 6; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const opt = document.createElement("option");
        opt.value = `${d.getFullYear()}-${d.getMonth()}`;
        opt.textContent = d.toLocaleString("default", { month: "long", year: "numeric" });
        monthSelect.appendChild(opt);
      }
    }

    monthSelect.onchange = () => {
      const [y, m] = monthSelect.value.split("-");
      renderCalendar(+y, +m);
    };

    saveBtn.onclick = () => {
      update(ref(db, `rayyan/classes/${selectedDate}`), {
        topic: topicInput.value,
        subject: subjectSelect.value,
        status: "taken"
      });

      update(ref(db, `rayyan/overall/${subjectSelect.value}`), {
        [selectedDate]: topicInput.value
      });

      modal.style.display = "none";
      topicInput.value = "";
    };

    loadMonths();
    const now = new Date();
    renderCalendar(now.getFullYear(), now.getMonth());

    onValue(ref(db, "rayyan/overall"), s => {
      document.getElementById("mathsTopics").innerHTML = "";
      document.getElementById("physicsTopics").innerHTML = "";

      Object.values(s.val()?.maths || {}).forEach(t =>
        mathsTopics.innerHTML += `<li>${t}</li>`
      );
      Object.values(s.val()?.physics || {}).forEach(t =>
        physicsTopics.innerHTML += `<li>${t}</li>`
      );
    });

  });
</script>

</body>
</html>
